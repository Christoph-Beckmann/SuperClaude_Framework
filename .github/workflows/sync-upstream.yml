name: ðŸ”„ Sync Fork with Upstream

on:
  schedule:
    - cron: '0 4 * * *'  # Daily at 4:00 UTC
  workflow_dispatch:     # Manual trigger
    inputs:
      sync_method:
        description: 'Sync method'
        required: true
        default: 'rebase'
        type: choice
        options:
          - rebase
          - merge
          - smart  # Try rebase, fall back to merge if conflicts

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Fork Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Fetch all history for proper rebasing

      - name: ðŸ”§ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: ðŸ”— Add Upstream Remote
        run: |
          git remote add upstream https://github.com/SuperClaude-Org/SuperClaude_Framework.git || true
          git remote -v

      - name: ðŸ“¥ Fetch All Remotes
        run: |
          echo "ðŸ“¥ Fetching all remotes..."
          git fetch --all --prune
          git fetch upstream master
          git fetch origin main

      - name: ðŸ” Check for Unpushed Commits
        id: check_unpushed
        run: |
          UNPUSHED_COUNT=$(git rev-list HEAD --not --remotes=origin | wc -l)
          if [ "$UNPUSHED_COUNT" -gt 0 ]; then
            echo "âš ï¸ Warning: $UNPUSHED_COUNT unpushed commits detected"
            echo "has_unpushed=true" >> $GITHUB_OUTPUT
            git log --oneline HEAD --not --remotes=origin
          else
            echo "âœ… No unpushed commits"
            echo "has_unpushed=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ”€ Check for Updates
        id: check
        run: |
          # Ensure we're on the right branch
          git checkout main || git checkout -b main origin/main

          LOCAL_COMMIT=$(git rev-parse main)
          UPSTREAM_COMMIT=$(git rev-parse upstream/master)

          if [ "$LOCAL_COMMIT" = "$UPSTREAM_COMMIT" ]; then
            echo "âœ… Already up-to-date with upstream"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“Š Updates available from upstream"
            echo "has_updates=true" >> $GITHUB_OUTPUT

            # Show what will be synced
            echo "ðŸ“ Commits to be synced:"
            git log --oneline main..upstream/master | head -20

            # Count commits
            COMMIT_COUNT=$(git rev-list --count main..upstream/master)
            echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Total commits to sync: $COMMIT_COUNT"
          fi

      - name: ðŸ”’ Create Backup Branch
        if: steps.check.outputs.has_updates == 'true'
        run: |
          BACKUP_BRANCH="backup-$(date +%Y%m%d-%H%M%S)"
          git branch $BACKUP_BRANCH main
          echo "ðŸ’¾ Created backup branch: $BACKUP_BRANCH"
          echo "backup_branch=$BACKUP_BRANCH" >> $GITHUB_ENV

      - name: ðŸ” Sync with Upstream (Smart Mode)
        if: steps.check.outputs.has_updates == 'true' && github.event.inputs.sync_method == 'smart'
        id: smart_sync
        run: |
          echo "ðŸŽ¯ Smart sync mode: attempting rebase first..."
          git checkout main

          # Try rebase first
          if git rebase upstream/master; then
            echo "âœ… Rebase successful"
            echo "sync_result=rebase_success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Rebase failed, attempting merge..."
            git rebase --abort

            # Fall back to merge
            if git merge upstream/master --no-edit; then
              echo "âœ… Merge successful"
              echo "sync_result=merge_success" >> $GITHUB_OUTPUT
            else
              echo "âŒ Both rebase and merge failed"
              echo "sync_result=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: ðŸ” Sync with Upstream (Rebase)
        if: steps.check.outputs.has_updates == 'true' && github.event.inputs.sync_method == 'rebase' && github.event.inputs.sync_method != 'smart'
        id: rebase_sync
        run: |
          echo "ðŸ”„ Rebasing main on upstream/master..."
          git checkout main

          if git rebase upstream/master; then
            echo "âœ… Rebase successful"
            echo "sync_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Rebase failed - conflicts detected"
            git rebase --abort
            echo "sync_result=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ðŸ”€ Sync with Upstream (Merge)
        if: steps.check.outputs.has_updates == 'true' && github.event.inputs.sync_method == 'merge' && github.event.inputs.sync_method != 'smart'
        id: merge_sync
        run: |
          echo "ðŸ”€ Merging upstream/master into main..."
          git checkout main

          if git merge upstream/master --no-edit; then
            echo "âœ… Merge successful"
            echo "sync_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Merge failed - conflicts detected"
            echo "sync_result=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ðŸ“¤ Push Changes
        if: steps.check.outputs.has_updates == 'true'
        id: push
        run: |
          # First try with --force-with-lease for safety
          if git push origin main --force-with-lease; then
            echo "âœ… Fork synced successfully with upstream/master"
            echo "push_result=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Force-with-lease failed, trying regular push..."
            if git push origin main; then
              echo "âœ… Fork synced successfully with upstream/master"
              echo "push_result=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ Push failed"
              echo "push_result=failed" >> $GITHUB_OUTPUT

              # Provide recovery instructions
              echo "### Recovery Instructions" >> $GITHUB_STEP_SUMMARY
              echo "To recover from the backup branch:" >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              echo "git checkout ${{ env.backup_branch }}" >> $GITHUB_STEP_SUMMARY
              echo "git branch -D main" >> $GITHUB_STEP_SUMMARY
              echo "git branch -m main" >> $GITHUB_STEP_SUMMARY
              echo "git push origin main --force" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY

              exit 1
            fi
          fi

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "### Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.has_updates }}" = "true" ]; then
            echo "âœ… **Fork has been synced with upstream/master**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Method:** ${{ github.event.inputs.sync_method || 'rebase' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Latest commits from upstream:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git log --oneline -5 upstream/master >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Fork is already up-to-date with upstream/master**" >> $GITHUB_STEP_SUMMARY
          fi